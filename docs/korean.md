# 렌더링된 배경에서 투명값 추출해내기

## 목적
게임에 등장하는 캐릭터나 오브젝트를 이미지로 캡쳐하여 사용하고자 할 경우, 투명 값을 처리하는 데 어려움을 겪 습니다. <투명한 배경> 위에서 알파 블렌딩이 일어나지 않기 때문에, 렌더링 당시의 배경 색상에 영향을 받기 때문 이죠.

그러나 다음 두 상태의 이미지가 있다면, 비교적 쓸만한 투명값을 추출해낼 수 있습니다.

* 하얀색 (255, 255, 255) 배경에서 찍은 렌더링 결과
* 검정색 (0, 0, 0) 배경에서 찍은 렌더링 결과

## 알파 블렌딩
배경 컬러 [S] 위에 특정 컬러 [C] 를 투명도 [A] 로 알파 블렌딩했을 경우, (A : 0 = 투명, 1 = 불투명) 최종 컬러 [T]는 다음과 같이 계산됩니다.

```
T = S * (1 - A) + C * A
```

(이러한 블렌딩은 Red, Green, Blue 각 색상 요소에 별도로 계산이 됩니다.)

우리는 주어진 결과에서 색상값(C)과 투명도(A)를 유추해내야 합니다.
하얀색 배경 (255, 255, 255) 과 검은색 배경(0, 0, 0)의 경우 다음과 같이 계산됩니다.
```
T_white = 255 * (1 - A) + C * A
T_black = 0 * (1 - A) + C * A = C * A
```

연립 방정식을 풀면
```
T_white - T_black = 255 * (1 - A)
```

A = 1, 즉 불투명인 경우는 T_white 와 T_black 이 같습니다.
즉, 하얀색 배경에서 찍을 때와 검은색 배경에서 찍었을 때의 색상값이 같다면
 * S = T_white
 * A = 1 

이 됩니다.

그 외에는 :
```
A = 1 + (T_black - T_white) / 255
```
로 투명도를 유추할 수 있습니다.

A가 0일 경우는
```
C = T_white
A = 0 
```
로 처리하면 되며, (색상은 중요하지 않습니다)
A가 0이 아닐 경우에는 다음 두 값을 구해서
```
C = T_black / A
C = 255 + (T_white - 255) / A 
```
두 후보 값을 구한 후, 평균을 냅니다.

이러한 계산을 Red, Green, Blue 각 요소에 계산하여 컬러값을 얻어냅니다.
투명도는 세 요소 중 가장 낮게 나온 값을 기준으로 합니다.

T_white와 T_black 의 범위는 0~255 이므로, 256x256 케이스를 모아서 미리 컬러/투명도 맵을 만들 수도 있습니다.

## 예제 코드
간단하게 C#로 만든 예제는 src/csharp 에서 확인할 수 있습니다.

 